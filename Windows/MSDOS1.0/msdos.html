 <!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://yopokiq.github.io/Emulators/Windows/styles/bg.css">
    <link rel="stylesheet" href="https://yopokiq.github.io/Emulators/Windows/styles/font.css">
    <link id="favicon" rel="icon" href="https://iili.io/207HCAu.png" type="image/png">
    <style>
        html, body, div, input {
            font-family: "Fixedsys 62";
        }

        /* Output container style */
        #output-container {
            white-space: pre-wrap;
            margin-top: 0;
        }

        /* Make the input container take up the full width */
        #input-container {
            width: 100%;
        }

        /* Hide the cursor globally */
        html, body {
            cursor: none; /* Hide cursor everywhere */
        }

        /* Keep cursor visible inside the editable input */
        #userInput {
            display: inline-block;
            min-width: 100%;
            word-wrap: break-word;
            caret-color: white; /* Visible cursor */
        }
    </style>
    <title>MS-DOS 1.0 Emulator</title>
</head>
<body class="black">
    <div class="black">
        MS-DOS Version 1.0<br>
        Copyright (C) Microsoft Corp 1981<br>
    </div>
    <div id="output-container" class="black"></div>
    <div id="input-container">
        <div class="black">
            <span>A:&gt;</span>
            <div contenteditable="true" id="userInput"></div>
        </div>
    </div>

<script>
    // Ensure the input always has focus and is selected
    function focusAndSelectInput() {
        const userInput = document.getElementById("userInput");
        userInput.focus(); // Focus on the contenteditable div

        const range = document.createRange();
        const selection = window.getSelection();
        range.selectNodeContents(userInput); // Select the entire content of the input
        selection.removeAllRanges();
        selection.addRange(range); // Apply the selection to the input
    }

    // Call this function initially to focus and select the input when the page loads
    window.addEventListener("load", function() {
        focusAndSelectInput();
    });

    // Always ensure the input is focused and selected after each input event
    const userInput = document.getElementById("userInput");
    userInput.addEventListener('input', function() {
        focusAndSelectInput(); // Keep the input focused and selected during typing
    });

    // Function to check the theme preference and set the favicon accordingly
    function setFaviconBasedOnTheme() {
        const darkModeFavicon = "https://iili.io/207HCAu.png";
        const lightModeFavicon = "https://iili.io/205OIEP.png";
        const isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        const favicon = document.getElementById('favicon');
        
        if (isDarkMode) {
            favicon.href = darkModeFavicon;
        } else {
            favicon.href = lightModeFavicon;
        }
    }
    
    setFaviconBasedOnTheme();
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', setFaviconBasedOnTheme);

    // Load files from localStorage or use default files
    let files = JSON.parse(localStorage.getItem("files")) || [
        {"filename": "MSDOS.SYS", "content": "<system-code-placeholder>"},
        {"filename": "IO.SYS", "content": "<system-code-placeholder>"},
        {"filename": "COMMAND.COM", "content": "<system-code-placeholder>"}
    ];

    const outputContainer = document.getElementById("output-container");

    let inFileCreation = false;
    let currentFileName = '';
    let currentFileType = '';

    // Save files to localStorage
    function saveFiles() {
        localStorage.setItem("files", JSON.stringify(files));
    }

    // Function to move cursor to the far right after every input
    function moveCursorToEnd() {
        const range = document.createRange();
        const selection = window.getSelection();
        range.selectNodeContents(userInput);
        range.collapse(false);
        selection.removeAllRanges();
        selection.addRange(range);
    }

    // Event listener to convert input to uppercase
    userInput.addEventListener('input', function() {
        userInput.innerText = userInput.innerText.toUpperCase();
        moveCursorToEnd();  // Ensure the cursor remains at the end of the text
    });

    userInput.addEventListener('keydown', function(event) {
        // Detect Ctrl/Cmd + Z and insert ^Z into the input
        if ((event.ctrlKey || event.metaKey) && event.key === "z") {
            event.preventDefault(); // Prevent the default undo action
            
            // Insert ^Z at the cursor position as a single character
            const cursorPosition = userInput.selectionStart;
            const currentText = userInput.innerText;
            const newText = currentText.slice(0, cursorPosition) + '^Z' + currentText.slice(cursorPosition);

            userInput.innerText = newText;

            // Move the cursor position after ^Z
            userInput.selectionStart = userInput.selectionEnd = cursorPosition + 3; // Length of "^Z" is 3
            moveCursorToEnd(); // Ensure the cursor moves to the end
        } else if (event.key === "Backspace" || event.key === "Delete") {
            const cursorPosition = userInput.selectionStart;
            const currentText = userInput.innerText;

            // Handle backspace and delete with ^Z
            if (cursorPosition < currentText.length && currentText.slice(cursorPosition, cursorPosition + 2) === "^Z") {
                event.preventDefault();
                
                const newText = currentText.slice(0, cursorPosition) + currentText.slice(cursorPosition + 2);
                userInput.innerText = newText;

                userInput.selectionStart = userInput.selectionEnd = cursorPosition;
                moveCursorToEnd(); 
            }
        } else if (event.key === "Enter") {
            let inputText = userInput.innerText.trim();
            let commandOutput = '';

            // Implement basic file system commands
            if (inputText === "DIR") {
                commandOutput = [
                    "Directory of A has no label",
                    "Directory of A:\\",
                    ...files.map(file => file.filename)
                ].join("\n");
            }
            else if (inputText.startsWith("COPY ")) {
                let args = inputText.slice(5).split(" ");
                if (args.length === 2) {
                    let sourceFile = args[0];
                    let destFile = args[1];

                    let file = files.find(file => file.filename === sourceFile);
                    if (file) {
                        files.push({
                            "filename": destFile,
                            "content": file.content
                        });
                        saveFiles();
                    } else {
                        commandOutput = "Bad command or file name";
                    }
                }
            } else if (inputText.startsWith("DEL ")) {
                let fileToDelete = inputText.slice(4);
                let fileIndex = files.findIndex(file => file.filename === fileToDelete);
                if (fileIndex !== -1) {
                    files.splice(fileIndex, 1);
                    saveFiles();
                    commandOutput = "Bad command or file name";
                } else {
                    commandOutput = "Bad command or file name";
                }
            } else if (inputText.startsWith("REN ")) {
                let args = inputText.slice(4).split(" ");
                if (args.length === 2) {
                    let oldName = args[0];
                    let newName = args[1];

                    let fileIndex = files.findIndex(file => file.filename === oldName);
                    if (fileIndex !== -1) {
                        files[fileIndex].filename = newName;
                        saveFiles();
                    } else {
                        commandOutput = "Bad command or file name";
                    }
                } else {
                    commandOutput = "Bad command or file name";
                }
            } else if (inputText.startsWith("TYPE ")) {
                let fileName = inputText.slice(5);
                let file = files.find(file => file.filename === fileName);
                if (file) {
                    commandOutput = file.content;
                } else {
                    commandOutput = "Bad command or file name";
                }
            }
            else if (inputText.trim() === "") {
                // Handle empty input
            } else if (inputText.startsWith("COPY CON ")) {
                let fileNameAndType = inputText.split("COPY CON ")[1];
                let fileNameParts = fileNameAndType.split(".");

                let fileName = fileNameParts[0];
                let fileType = fileNameParts[1];

                if (fileName.length <= 8 && fileType.length <= 3) {
                    currentFileName = fileName;
                    currentFileType = fileType;

                    let existingFileIndex = files.findIndex(file => file.filename === `${currentFileName}.${currentFileType}`);
                    if (existingFileIndex !== -1) {
                        files.splice(existingFileIndex, 1); // Overwrite existing file
                    }

                    inFileCreation = true;
                    commandOutput = ''; // No extra message
                } else {
                    commandOutput = "Bad command or file name";
                }
            } else {
                commandOutput = "Bad command or file name";
            }

            // Output the command and result
            outputContainer.textContent += `A:> ${inputText}\n${commandOutput}\n`;

            // Clear input and move cursor to end
            userInput.innerText = '';
            moveCursorToEnd();
            event.preventDefault();
        }
    });
</script>
</body>
</html>
